<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Image Recognition Examples</title>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" />

        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
            <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <style type="text/css">
            .loading {
                background-color: #ccc;
                padding: 20px;
                font-weight: bold;
                font-size: 16px;
                text-align: center;
            }
        </style>
    </head>
    <body>

        <nav class="navbar navbar-default">
            <div class="container">
                <div class="navbar-header text-center">
                    <h3>Image Recognition as a Service</h3>
                </div>
            </div>
        </nav>
        <div class="container">
            <div class="row">
                <div class="col-xs-3">
                    <h2 class="text-center">Choose an Image</h2>
                    <ul>
                        <li><a class="sample-image" href="https://storage.googleapis.com/doc-image-rec/images/image1.jpg">Image 1</a></li>
                        <li><a class="sample-image" href="https://storage.googleapis.com/doc-image-rec/images/image2.jpg">Image 2</a></li>
                        <li><a class="sample-image" href="https://storage.googleapis.com/doc-image-rec/images/image3.jpg">Image 3</a></li>
                    </ul>
                </div>
                <div id="step-2" class="col-xs-6" style="display:none;">
                    <h2 class="text-center">POST to Google API</h2>
                    <p id="analyze-button" class="text-center" style="display:none;">
                        <a id="analyze" class="btn btn-lg btn-primary">Analyze Image</a>
                    </p>
                    <p id="current-image" class="text-center center-block"></p>
                </div>
                <div id="step-3" class="col-xs-3" style="display:none;">
                    <h2 class="text-center">Enjoy the Results</h2>
                    <p id="gcp-results"></p>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="config.js"></script>
        <script type="text/javascript">
            $("a.sample-image").click(function(e) {
                e.preventDefault();

                var imageUrl = $(this).attr('href');

                var image = $("<img></img>");
                image.attr('src', imageUrl);
                image.attr('class', 'img-responsive center-block');
                $("#current-image").empty().append(image);
                $("#analyze-button").show();
                $("#step-2").show();
                $("#step-3").hide();

                $("#gcp-results").empty();
            });

            $("#analyze").click(function(e) {
                $("#step-3").show();

                var gcp = $("#gcp-results");
                var azure = $("#azure-results");
                var ryo = $("#ryo-results");

                gcp.empty();

                gcp.addClass("loading");
                gcp.append("<p>Reticulating Splines...</p>");

                var imageUrl = $("#current-image img").attr('src');

                var requestData = {
                    "requests": [
                        {
                        "image": {
                            "source": {
                            "imageUri": imageUrl
                            }
                        },
                        "features": [
                            {
                            "type": "LABEL_DETECTION"
                            }
                        ]
                        }
                    ]
                };
                console.log(requestData);

                axios.post('https://vision.googleapis.com/v1/images:annotate?key=' + GCP_API_KEY, requestData)
                .then(function (response) {
                    var isHotDog = false;
                    var confidence = 0.0;

                    if (response.data.responses[0].labelAnnotations != undefined) {
                        //console.log(response.data.responses[0].labelAnnotations.length);
                        //console.log(response.data.responses[0].labelAnnotations);
                        var result = $("<ul></ul>");
                        for (var i = 0; i < response.data.responses[0].labelAnnotations.length; i++)
                        {
                            var annotation = response.data.responses[0].labelAnnotations[i];
                            //result.append("<li>" + annotation.description + " (" + Math.round(Number(annotation.score)*100, 2) + "%)</li>");
                            if (annotation.description.toLowerCase() == "hot dog") {
                                isHotDog = true;
                                confidence = Math.round(Number(annotation.score)*100, 2);
                            }
                        }
                        //gcp.append(result);

                        if (isHotDog) {
                            result = $('<h1 class="text-center text-success"><span class="glyphicon glyphicon-ok"></span></h1><h2 class="text-center text-success">HOT DOG</h2><h6 class="text-center">(' + confidence + '%)</h6>');
                        } else {
                            result = $('<h1 class="text-center text-danger"><span class="glyphicon glyphicon-remove"></span></h1><h2 class="text-center text-danger">NOT HOT DOG</h2>');
                        }
                        gcp.removeClass("loading");
                        gcp.empty().append(result);
                    } else {
                        gcp.append("<p>There was an error: " + response.data.responses[0].error.message + "</p>");
                    }
                })
                .catch(function (error) {
                    console.log(error);
                });
            });
        </script>
    </body>
</html>